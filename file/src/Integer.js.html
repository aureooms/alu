<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/Integer.js | @aureooms/js-integer</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<link rel="stylesheet" href="./inject/css/0-style.css"><script src="./inject/script/0-header.js"></script><meta name="description" content="Integers for JavaScript"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="@aureooms/js-integer"><meta property="twitter:description" content="Integers for JavaScript"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/aureooms/js-integer"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Integer.js~Integer.html">Integer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/IntegerRing.js~IntegerRing.html">IntegerRing</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ZeroDivisionError.js~ZeroDivisionError.html">ZeroDivisionError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-_from_number">_from_number</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-$0">$0</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-$1">$1</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-$_1">$_1</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-add">add</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addn">addn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-div">div</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-divmod">divmod</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-divmodn">divmodn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-divn">divn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-iadd">iadd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-iaddn">iaddn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-idiv">idiv</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-idivmod">idivmod</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-idivmodn">idivmodn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-idivn">idivn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-imod">imod</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-imodn">imodn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-imul">imul</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-imuln">imuln</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ipow">ipow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ipown">ipown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isub">isub</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isubn">isubn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mod">mod</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-modn">modn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mul">mul</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-muln">muln</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parse">parse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pow">pow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pown">pown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stringify">stringify</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sub">sub</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-subn">subn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_DISPLAY_BASE">DEFAULT_DISPLAY_BASE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_REPRESENTATION_BASE">DEFAULT_REPRESENTATION_BASE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ZZ">ZZ</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-MAX_BASE">MAX_BASE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-MAX_NUMBER">MAX_NUMBER</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-MIN_BASE">MIN_BASE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-MIN_NUMBER">MIN_NUMBER</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/Integer.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {DEFAULT_DISPLAY_BASE} from &apos;./DEFAULT_DISPLAY_BASE.js&apos;;
import {ZeroDivisionError} from &apos;./ZeroDivisionError.js&apos;;

import {ValueError} from &apos;@aureooms/js-error&apos;;

import {_from_number} from &apos;./_from_number.js&apos;;

import {
	stringify,
	convert,
	_trim_positive,
	_alloc,
	_copy,
	_zeros,
	jz,
	cmp,
	eq,
	add,
	_sub,
	mul,
	_idivmod,
	_pow_double,
	increment,
	euclidean_algorithm,
	extended_euclidean_algorithm,
} from &apos;@aureooms/js-integer-big-endian&apos;;

import {MIN_NUMBER, MAX_NUMBER, MAX_BASE} from &apos;./_limits.js&apos;;

export class Integer {
	constructor(base, is_negative, limbs) {
		this._base = base;
		this._is_negative = is_negative;
		this._limbs = limbs;
	}

	move(other) {
		other._base = this._base;
		other._is_negative = this._is_negative;
		other._limbs = this._limbs;
		return other;
	}

	clone() {
		return new Integer(this._base, this._is_negative, this._limbs);
	}

	_limbs_in_base(base) {
		// TODO save result for later ? Maybe replace base ?
		return this._base === base
			? this._limbs
			: convert(this._base, base, this._limbs, 0, this._limbs.length);
	}

	toString(base = DEFAULT_DISPLAY_BASE) {
		if (this.iszero()) return &apos;0&apos;;

		const digits = stringify(
			this._base,
			base,
			this._limbs,
			0,
			this._limbs.length,
		);

		return this._is_negative ? &apos;-&apos; + digits : digits;
	}

	add(other) {
		if (this._is_negative !== other._is_negative) {
			return other._is_negative
				? this.sub(other.opposite())
				: other.sub(this.opposite());
		}

		const result_is_negative = this._is_negative;
		const r = this._base;

		const a = this._limbs;

		const b = other._limbs_in_base(r);

		const c = _zeros(Math.max(a.length, b.length) + 1);

		add(r, a, 0, a.length, b, 0, b.length, c, 0, c.length);

		return new Integer(r, result_is_negative, c);
	}

	iadd(other) {
		// TODO optimize but be careful with side effects
		return this.add(other).move(this);
	}

	addn(number) {
		// TODO optimize
		return this.add(_from_number(number));
	}

	iaddn(number) {
		// TODO optimize but be careful with side effects
		return this.addn(number).move(this);
	}

	sub(other) {
		if (this._is_negative !== other._is_negative) {
			return other._is_negative
				? this.add(other.opposite())
				: this.opposite().add(other).opposite();
		}
		// /!\ _sub needs |c| &gt;= |a| &gt;= |b|

		const r = this._base;
		const a = this._limbs;
		const aj = a.length;
		const ai = _trim_positive(a, 0, aj);

		if (ai &gt;= aj) return other.opposite();

		const b = other._limbs_in_base(r);
		const bj = b.length;
		const bi = _trim_positive(b, 0, bj);

		if (bi &gt;= bj) return this.clone();

		if (cmp(a, ai, aj, b, bi, bj) &lt; 0) {
			const c = _zeros(bj - bi);

			_sub(r, b, bi, bj, a, ai, aj, c, 0, c.length);

			return new Integer(r, ~this._is_negative, c);
		}

		const c = _zeros(aj - ai);

		_sub(r, a, ai, aj, b, bi, bj, c, 0, c.length);

		return new Integer(r, this._is_negative, c);
	}

	isub(other) {
		// TODO optimize but be careful with side effects
		return this.sub(other).move(this);
	}

	subn(number) {
		return this.sub(_from_number(number));
	}

	isubn(number) {
		return this.subn(number).move(this);
	}

	mul(other) {
		const result_is_negative = this._is_negative ^ other._is_negative;
		const r = this._base;

		const a = this._limbs;

		const b = other._limbs_in_base(r);

		const c = _zeros(a.length + b.length);

		mul(r, a, 0, a.length, b, 0, b.length, c, 0, c.length);

		return new Integer(r, result_is_negative, c);
	}

	imul(other) {
		// TODO optimize but be careful with side effects
		return this.mul(other).move(this);
	}

	muln(number) {
		return this.mul(_from_number(number));
	}

	imuln(number) {
		return this.muln(number).move(this);
	}

	/**
	 * Computes &lt;code&gt;this&lt;/code&gt; raised to the &lt;code&gt;x&lt;/code&gt;th power.
	 * &lt;code&gt;x&lt;/code&gt; is a double smaller or equal to 2^53.
	 *
	 * @param {Number} x The power to raise &lt;code&gt;this&lt;/code&gt; to.
	 * @return {Integer} &lt;code&gt;this ^ x&lt;/code&gt;
	 */
	pown(x) {
		const is_negative = this._is_negative &amp; x &amp; 1 ? -1 : 0;

		const a = this._limbs;
		const c = _zeros(Math.max(1, a.length * x));

		_pow_double(this._base, x, a, 0, a.length, c, 0, c.length);

		return new Integer(this._base, is_negative, c);
	}

	pow(other) {
		return this.pown(other.valueOf());
	}

	ipow(other) {
		// TODO optimize but be careful with side effects
		return this.pow(other).move(this);
	}

	ipown(number) {
		// TODO optimize but be careful with side effects
		return this.pown(number).move(this);
	}

	square() {
		// TODO optimize but be careful with side effects
		// TODO use this.mul(this) instead?
		return this.pown(2);
	}

	isquare() {
		// TODO optimize but be careful with side effects
		// TODO use this.imul(this) instead?
		return this.square().move(this);
	}

	div(other) {
		return this.divmod(other)[0];
	}

	divn(number) {
		return this.div(_from_number(number));
	}

	idiv(other) {
		// TODO optimize but be careful with side effects
		return this.div(other).move(this);
	}

	idivn(number) {
		return this.divn(number).move(this);
	}

	mod(other) {
		return this.divmod(other)[1];
	}

	modn(number) {
		return this.mod(_from_number(number));
	}

	imod(other) {
		// TODO optimize but be careful with side effects
		return this.mod(other).move(this);
	}

	imodn(number) {
		return this.modn(number).move(this);
	}

	divround(other) {
		const [q, r] = this.divmod(other);
		if (r.ge(other.divn(2).addn(other.iseven() ? 0 : 1)))
			increment(q._base, q._limbs, 0, q._limbs.length);
		return q;
	}

	divmod(other) {
		if (other.iszero()) throw new ZeroDivisionError(&apos;Integer division by zero&apos;); // Optimize

		const quotient_is_negative = this._is_negative ^ other._is_negative;
		const r = this._base;

		// The underlying algorithm does not allow leading 0&apos;s so we trim them.
		const lj = this._limbs.length;
		const li = _trim_positive(this._limbs, 0, lj);

		// Dividend is 0
		if (li &gt;= lj)
			return [new Integer(this._base, 0, [0]), new Integer(this._base, 0, [0])];

		// Dividend (&amp; Remainder)
		const D = _alloc(lj - li);
		_copy(this._limbs, li, lj, D, 0);

		// Divisor
		const d = other._limbs_in_base(r);
		const dj = d.length;
		const di = _trim_positive(d, 0, dj); // Di &lt; dj because d != 0

		// Quotient
		const q = _zeros(D.length);

		_idivmod(r, D, 0, D.length, d, di, dj, q, 0, q.length);

		const Q = new Integer(r, quotient_is_negative, q); // Quotient
		const R = new Integer(r, 0, D); // Remainder

		if ((this._is_negative || other._is_negative) &amp;&amp; !jz(D, 0, D.length)) {
			if (other._is_negative) {
				if (this._is_negative) {
					R.negate(); // TODO optimize
				} else {
					increment(r, q, 0, q.length);
					R.iadd(other); // TODO optimize
				}
			} else {
				increment(r, q, 0, q.length);
				R.negate().iadd(other); // TODO optimize
			}
		}

		return [Q, R];
	}

	idivmod(other) {
		// TODO optimize but be careful with side effects
		const [q, r] = this.divmod(other);
		return [q, r.move(this)];
	}

	divmodn(number) {
		return this.divmod(_from_number(number));
	}

	idivmodn(number) {
		const [q, r] = this.divmodn(number);
		return [q, r.move(this)];
	}

	opposite() {
		return new Integer(this._base, ~this._is_negative, this._limbs);
	}

	negate() {
		// TODO optimize but be careful with side effects
		return this.opposite().move(this);
	}

	abs() {
		return this.sign() &gt;= 0 ? this : this.opposite();
	}

	iabs() {
		return this.abs().move(this);
	}

	sign() {
		return this.iszero() ? 0 : this._is_negative ? -1 : 1;
	}

	iszero() {
		return jz(this._limbs, 0, this._limbs.length);
	}

	isone() {
		if (this._is_negative) return false;
		return eq(this._limbs, 0, this._limbs.length, [1], 0, 1);
	}

	isnonzero() {
		return !this.iszero();
	}

	isnegative() {
		return this._is_negative === -1;
	}

	ispositive() {
		return this.sign() &gt; 0;
	}

	isnonnegative() {
		return !this.isnegative();
	}

	isnonpositive() {
		return !this.ispositive();
	}

	parity() {
		// TODO optimize this, there is a much faster way to test for parity
		// when the base is a multiple of two
		return this.modn(2);
	}

	iseven() {
		return this.parity().iszero();
	}

	isodd() {
		return !this.iseven();
	}

	bin() {
		return this.toString(2);
	}

	oct() {
		return this.toString(8);
	}

	hex() {
		return this.toString(16);
	}

	toJSON() {
		return this.hex();
	}

	digits(base = DEFAULT_DISPLAY_BASE) {
		// TODO Once #to is implemented we can rewrite this as
		// return this.to(LITTLE_ENDIAN, base, Array) ;
		return convert(
			this._base,
			base,
			this._limbs,
			0,
			this._limbs.length,
		).reverse();
	}

	bits() {
		return this.digits(2);
	}

	divides(other) {
		return other.mod(this).iszero();
	}

	divide_knowing_divisible_by(other) {
		// TODO optimize
		return this.div(other);
	}

	cmp(other) {
		// TODO optimize with _trim_positive

		if (this.iszero()) {
			if (other.iszero()) return 0;
			if (other._is_negative) return 1;
			return -1;
		}

		if (this._is_negative &lt; other._is_negative) return -1;
		if (this._is_negative &gt; other._is_negative) return 1;

		const a = this._limbs;
		const b = other._limbs_in_base(this._base);

		return this._is_negative === 0
			? cmp(a, 0, a.length, b, 0, b.length)
			: cmp(b, 0, b.length, a, 0, a.length);
	}

	cmpn(number) {
		return this.cmp(_from_number(number));
	}

	eq(other) {
		return this.cmp(other) === 0;
	}

	eqn(number) {
		return this.cmpn(number) === 0;
	}

	ge(other) {
		return this.cmp(other) &gt;= 0;
	}

	gen(number) {
		return this.cmpn(number) &gt;= 0;
	}

	gt(other) {
		return this.cmp(other) &gt; 0;
	}

	gtn(number) {
		return this.cmpn(number) &gt; 0;
	}

	le(other) {
		return this.cmp(other) &lt;= 0;
	}

	len(number) {
		return this.cmpn(number) &lt;= 0;
	}

	lt(other) {
		return this.cmp(other) &lt; 0;
	}

	ltn(number) {
		return this.cmpn(number) &lt; 0;
	}

	ne(other) {
		return this.cmp(other) !== 0;
	}

	nen(number) {
		return this.cmpn(number) !== 0;
	}

	gcd(other) {
		const r = this._base;
		const a = this._limbs;
		const b = other._limbs_in_base(r);
		const [d, di, dj] = euclidean_algorithm(r, a, 0, a.length, b, 0, b.length);
		const gcd = _alloc(dj - di);
		_copy(d, di, dj, gcd, 0);
		return new Integer(r, 0, gcd);
	}

	egcd(other) {
		const r = this._base;
		const a = this._limbs;
		const b = other._limbs_in_base(r);
		const [
			R0,
			R0i,
			S0,
			S0i,
			T0,
			T0i,
			S1,
			S1i,
			T1,
			T1i,
			steps,
		] = extended_euclidean_algorithm(r, a, 0, a.length, b, 0, b.length);
		const gcd = _alloc(R0.length - R0i);
		_copy(R0, R0i, R0.length, gcd, 0);
		const x = _alloc(S0.length - S0i);
		_copy(S0, S0i, S0.length, x, 0);
		const y = _alloc(T0.length - T0i);
		_copy(T0, T0i, T0.length, y, 0);
		const u = _alloc(S1.length - S1i);
		_copy(S1, S1i, S1.length, u, 0);
		const v = _alloc(T1.length - T1i);
		_copy(T1, T1i, T1.length, v, 0);
		return {
			// TODO use immutable zero
			gcd: new Integer(r, 0, gcd),
			x:
				x.length &gt; 0
					? new Integer(r, this._is_negative ^ ((steps % 2) - 1), x)
					: new Integer(r, 0, [0]),
			y:
				y.length &gt; 0
					? new Integer(r, other._is_negative ^ -(steps % 2), y)
					: new Integer(r, 0, [0]),
			u:
				u.length &gt; 0
					? new Integer(r, this._is_negative ^ -(steps % 2), u)
					: new Integer(r, 0, [0]),
			v:
				v.length &gt; 0
					? new Integer(r, other._is_negative ^ ((steps % 2) - 1), v)
					: new Integer(r, 0, [0]),
		};
	}

	valueOf() {
		if (this.gtn(MAX_NUMBER))
			throw new ValueError(
				`Cannot call valueOf on Integer larger than ${MAX_NUMBER}. Got ${this.toString()}`,
			);
		if (this.ltn(MIN_NUMBER))
			throw new ValueError(
				`Cannot call valueOf on Integer smaller than ${MIN_NUMBER}. Got ${this.toString()}`,
			);

		const limbs = convert(
			this._base,
			MAX_BASE,
			this._limbs,
			0,
			this._limbs.length,
		);

		const sign = this._is_negative ? -1 : 1;

		const value =
			limbs.length === 2 ? limbs[0] * MAX_BASE + limbs[1] : limbs[0];

		return sign * value;
	}

	toNumber() {
		return this.valueOf();
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
